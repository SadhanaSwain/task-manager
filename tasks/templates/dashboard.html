{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">Welcome, {{ request.user.username }}! 🎉</h2>

<!-- 🔍 Search, Filter, Sort Form -->
<form method="GET" class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <input type="text" name="search" value="{{ search_query }}" class="form-control" placeholder="🔍 Search by title">
  </div>

  <div class="col-md-2 col-sm-6">
    <select name="status" class="form-select">
      <option value="">All Statuses</option>
      <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
      <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
      <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
    </select>
  </div>

  <div class="col-md-2 col-sm-6">
    <select name="category" class="form-select">
      <option value="">All Categories</option>
      <option value="Work" {% if category_filter == 'Work' %}selected{% endif %}>Work</option>
      <option value="Personal" {% if category_filter == 'Personal' %}selected{% endif %}>Personal</option>
      <option value="Other" {% if category_filter == 'Other' %}selected{% endif %}>Other</option>
    </select>
  </div>

  <div class="col-md-2 col-sm-6">
    <input type="text" name="tags" value="{{ tag_filter }}" class="form-control" placeholder="🏷 Tags">
  </div>

  <div class="col-md-2 col-sm-6">
    <select name="sort_by" class="form-select">
      <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date ↑</option>
      <option value="-due_date" {% if sort_by == '-due_date' %}selected{% endif %}>Due Date ↓</option>
      <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created ↑</option>
      <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Created ↓</option>
      <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority A-Z</option>
      <option value="-priority" {% if sort_by == '-priority' %}selected{% endif %}>Priority Z-A</option>
      <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title A-Z</option>
      <option value="-title" {% if sort_by == '-title' %}selected{% endif %}>Title Z-A</option>
    </select>
  </div>

  <div class="col-md-1 col-sm-6">
    <button type="submit" class="btn btn-primary w-100">Filter</button>
  </div>
</form>

<!-- ➕ Add New Task -->
<div class="mb-3">
  <a href="{% url 'create_task' %}" class="btn btn-success">+ Add New Task</a>
</div>

<!-- 📋 Task Table -->
{% if page_obj %}
<table class="table table-striped table-bordered">
  <thead class="table-dark">
    <tr>
      <th>Title</th>
      <th>Status</th>
      <th>Due Date</th>
      <th>Category</th>
      <th>Priority</th>
      <th>Tags</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for task in page_obj %}
    <tr>
      <td>{{ task.title }}</td>
      <td>
        {% if task.status == 'Completed' %}
          <span class="badge bg-success">{{ task.status }}</span>
        {% elif task.status == 'In Progress' %}
          <span class="badge bg-warning text-dark">{{ task.status }}</span>
        {% else %}
          <span class="badge bg-secondary">{{ task.status }}</span>
        {% endif %}
      </td>
      <td>{{ task.due_date }}</td>
      <td>{{ task.category }}</td>
      <td>{{ task.priority }}</td>
      <td>{{ task.tags }}</td>
      <td>
        {% if task.status != 'Completed' %}
          <a href="{% url 'toggle_complete' task.id %}" class="btn btn-success btn-sm">✅ Complete</a>
        {% else %}
          <a href="{% url 'toggle_complete' task.id %}" class="btn btn-secondary btn-sm">↩ Undo</a>
        {% endif %}
        <a href="{% url 'edit_task' task.id %}" class="btn btn-warning btn-sm">✏ Edit</a>
        <a href="{% url 'delete_task' task.id %}" class="btn btn-danger btn-sm">🗑 Delete</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ⏭ Pagination -->
<nav>
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}&tags={{ tag_filter }}&sort_by={{ sort_by }}">« First</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}&tags={{ tag_filter }}&sort_by={{ sort_by }}">‹ Prev</a>
    </li>
    {% endif %}

    <li class="page-item active">
      <span class="page-link">{{ page_obj.number }}</span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}&tags={{ tag_filter }}&sort_by={{ sort_by }}">Next ›</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}&tags={{ tag_filter }}&sort_by={{ sort_by }}">Last »</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% else %}
<div class="alert alert-info">No tasks found. Try adjusting your filters.</div>
{% endif %}

{% endblock %}